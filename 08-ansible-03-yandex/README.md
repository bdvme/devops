*Студент: Дмитрий Багрянский*

# Домашняя работа

## Урок 8.3 Использование Yandex Cloud.

## Подготовка к выполнению

1. (Необязательно) Познакомтесь с [lighthouse](https://youtu.be/ymlrNlaHzIY?t=929)
2. Подготовьте в Yandex Cloud три хоста: для `clickhouse`, для `vector` и для `lighthouse`.

Ссылка на репозиторий LightHouse: https://github.com/VKCOM/lighthouse

## Основная часть

1. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает lighthouse.
2. При создании tasks рекомендую использовать модули: `get_url`, `template`, `yum`, `apt`.
3. Tasks должны: скачать статику lighthouse, установить nginx или любой другой webserver, настроить его конфиг для открытия lighthouse, запустить webserver.
4. Приготовьте свой собственный inventory файл `prod.yml`.
5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.
6. Попробуйте запустить playbook на этом окружении с флагом `--check`.
7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.
8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.
9. Подготовьте README.md файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.
10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-03-yandex` на фиксирующий коммит, в ответ предоставьте ссылку на него.

---

###### Ответы:

Установку clickhouse, vector и lighthouse делал с помощью Vagrant и Ansible.
в playbook `./src/ansible/provision.yml` содержатся задачи для развертывания ВМ, установки и настройки YandexCloud.

С помощью Terraform создаю 3 ВМ в облаке YandexCloud, использую динамическое создание inventory.yml для работы Ansible с хостами в облаке.

Playbook для установки clickhouse, vector и lighthouse содержит также задачи для установки nginx. В задачах используются шаблоны для подстановки конфигурационных файлов.

---

1. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает lighthouse.

```yaml
- name: Install Lighthouse
  hosts: lighthouse
  become: true
  tasks:
    - name: Create home directory for www
      file:
        path: {{ lighthouse_dir }}
        state: directory
    - name: Get lighthouse distrib
      git:
        repo: "{{ lighthouse_repo }}"
        version: master
        dest: "{{ lighthouse_dir }}"
```

3. Tasks должны: скачать статику lighthouse, установить nginx или любой другой webserver, настроить его конфиг для открытия lighthouse, запустить webserver.

```yaml

- name: Setup nginx
  hosts: lighthouse
  become: true
  handlers:
    - name: nginx start
      service:
        name: nginx
        state: started
        enabled: yes
  tasks:
    - name: Replace nginx.conf
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        mode: 0644
    - name: Add virtual domain in NGINX for CentOS
      template:
        src: lighthouse.conf.j2
        dest: /etc/nginx/conf.d/{{ virtual_domain }}.conf

    - name: Disable SELinux
      shell: |
        setenforce 0
        chown -R {{ nginx_user }}:{{ nginx_user }} {{ lighthouse_dir }}

      notify:
        - nginx start
```

4. Приготовьте свой собственный inventory файл `prod.yml`.

Файл генерируется динамически с помощью Terraform при создании инфраструктуры в YandexCloud.

```yaml
---
clickhouse:
  hosts:
    clickhouse-01:
      ansible_host: clickhouse-01.ip
      ansible_user: centos
vector:
  hosts:
    vector-01:
      ansible_host: vector-01.ip
      ansible_user: centos
lighthouse:
  hosts:
    lighthouse-01:
      ansible_host: lighthouse-01.ip
      ansible_user: centos
```

```yaml
resource "local_file" "prod" {
  content = <<-DOC
    # Ansible inventory containing variable values from Terraform.
    # Generated by Terraform.

    ---
    clickhouse:
      hosts:
        clickhouse-01:
          ansible_host: ${yandex_compute_instance.node01.network_interface.0.nat_ip_address}
          ansible_user: centos
          ansible_internal_host: ${yandex_compute_instance.node01.network_interface.0.ip_address}
    vector:
      hosts:
        vector-01:
          ansible_host: ${yandex_compute_instance.node02.network_interface.0.nat_ip_address}
          ansible_user: centos
          ansible_internal_host: ${yandex_compute_instance.node02.network_interface.0.ip_address}
    lighthouse:
      hosts:
        lighthouse-01:
          ansible_host: ${yandex_compute_instance.node03.network_interface.0.nat_ip_address}
          ansible_user: centos
          ansible_internal_host: ${yandex_compute_instance.node03.network_interface.0.ip_address}
    DOC
  filename = "../playbook/inventory/prod.yml"

  depends_on = [
    yandex_compute_instance.node01,
    yandex_compute_instance.node02,
    yandex_compute_instance.node03
  ]
}
```
